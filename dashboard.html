<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Electricity Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #003366; --bg: #f1f5f9; --teal: #00695c; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; }
        
        .sidebar { background: var(--primary); min-height: 100vh; color: white; position: fixed; width: 16.666667%; padding-top: 20px; z-index: 100; }
        .main-content { margin-left: 16.666667%; padding: 30px; }
        
        /* Flutter Card Style */
        .complaint-card { background: white; border-radius: 15px; border: none; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; transition: 0.3s; }
        .reopened-card { border: 1.5px solid #dc3545 !important; }
        
        /* Status Badges */
        .status-chip { font-size: 10px; font-weight: bold; padding: 3px 12px; border-radius: 20px; text-transform: uppercase; }
        .s-pending { background: #ffebee; color: #c62828; }
        .s-progress { background: #fff3e0; color: #ef6c00; }
        .s-resolved { background: #e8f5e9; color: #2e7d32; }
        .s-reopened { background: #000; color: #fff; }

        /* Priority Tags */
        .priority-tag { font-size: 10px; padding: 2px 8px; border-radius: 4px; font-weight: bold; margin-left: 10px; border: 1px solid; }

        /* Blinking Logic */
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .blink-badge { background: #dc3545; color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; animation: blink 0.8s infinite; }

        /* Buttons matching your Flutter Style */
        .btn-start { background-color: #ef6c00; color: white; border-radius: 20px; border: none; font-weight: bold; font-size: 12px; padding: 8px 20px; }
        .btn-resolve { background-color: #2e7d32; color: white; border-radius: 20px; border: none; font-weight: bold; font-size: 12px; padding: 8px 20px; }
        
        .detail-row { font-size: 13px; margin-bottom: 5px; display: flex; align-items: center; }
        .detail-row i { color: var(--teal); margin-right: 8px; width: 18px; }

        .remarks-area { font-size: 13px; border-radius: 10px; background: #f8fafc; }

        @media (max-width: 768px) { .sidebar { position: relative; width: 100%; min-height: auto; } .main-content { margin-left: 0; } }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-2 sidebar d-none d-md-block shadow">
            <h5 class="text-center mb-4 fw-bold"><i class="bi bi-lightning-charge-fill text-warning"></i> ADMIN</h5>
            <nav class="nav flex-column">
                <a class="nav-link text-white mb-2" href="#"><i class="bi bi-grid-1x2 me-2"></i> Complaints</a>
                <a class="nav-link text-white-50" href="javascript:void(0)" onclick="logout()"><i class="bi bi-box-arrow-left me-2"></i> Logout</a>
            </nav>
        </div>

        <div class="col-md-10 main-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">Grievance Dashboard</h3>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Search ID or Mobile..." onkeyup="loadComplaints()">
                </div>
            </div>

            <div class="row g-3 mb-4 text-center">
                <div class="col-md-3"><div class="p-3 bg-white rounded shadow-sm border-bottom border-danger border-4">
                    <small class="text-muted fw-bold">PENDING</small><h3 id="count-pending">0</h3></div></div>
                <div class="col-md-3"><div class="p-3 bg-white rounded shadow-sm border-bottom border-warning border-4">
                    <small class="text-muted fw-bold">IN PROGRESS</small><h3 id="count-progress">0</h3></div></div>
                <div class="col-md-3"><div class="p-3 bg-white rounded shadow-sm border-bottom border-success border-4">
                    <small class="text-muted fw-bold">RESOLVED</small><h3 id="count-resolved">0</h3></div></div>
                <div class="col-md-3"><div class="p-3 bg-white rounded shadow-sm border-bottom border-dark border-4">
                    <small class="text-muted fw-bold">REOPENED</small><h3 id="count-reopened">0</h3></div></div>
            </div>

            <div id="complaintsContainer">
                <div class="text-center py-5 text-muted">Loading grievances...</div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// GITHUB_ACTION_PLACEHOLDER
    let auth, db;

    function initFirebase() {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        auth = firebase.auth(); db = firebase.database();
        auth.onAuthStateChanged(user => { if(user) loadComplaints(); else window.location.href='index.html'; });
    }

    function getPriorityVal(p) {
        p = (p || '').toUpperCase();
        return p === 'HIGH' ? 1 : (p === 'MEDIUM' ? 2 : (p === 'LOW' ? 3 : 4));
    }

    function formatTime(ts) {
        if (!ts) return "Not available";
        return new Date(ts).toLocaleString('en-IN', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit', hour12: true });
    }

    function loadComplaints() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        db.ref('complaints').on('value', snap => {
            const container = document.getElementById('complaintsContainer');
            container.innerHTML = '';
            let list = [];
            let counts = { pending: 0, progress: 0, resolved: 0, reopened: 0 };

            snap.forEach(child => {
                const data = child.val();
                data.key = child.key;
                const status = (data.status || 'pending').toLowerCase();
                const id = (data.complaintId || data.key).toString().toLowerCase();
                const mob = (data.mobile || '').toString();

                if(status === 'resolved') counts.resolved++;
                else if(status === 'in progress') counts.progress++;
                else if(status.includes('reopened') || status.includes('re-opened')) counts.reopened++;
                else counts.pending++;

                if(search === "" || id.includes(search) || mob.includes(search)) {
                    list.push(data);
                }
            });

            list.sort((a, b) => getPriorityVal(a.priority) - getPriorityVal(b.priority));

            document.getElementById('count-pending').innerText = counts.pending;
            document.getElementById('count-progress').innerText = counts.progress;
            document.getElementById('count-resolved').innerText = counts.resolved;
            document.getElementById('count-reopened').innerText = counts.reopened;

            list.forEach(item => {
                const status = (item.status || 'pending').toLowerCase();
                const isReopened = status.includes('reopen') || status.includes('re-opened');
                const p = (item.priority || 'Medium').toUpperCase();
                const pColor = p === 'HIGH' ? '#dc3545' : (p === 'LOW' ? '#2e7d32' : '#f57c00');
                
                const currentRemarks = item.officer_remarks || "";
                const defaultText = isReopened ? "" : (currentRemarks === "" ? "Officer has acknowledged and started work on this grievance." : currentRemarks);

                container.innerHTML += `
                    <div class="card complaint-card ${isReopened ? 'reopened-card' : ''}">
                        <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center" 
                             style="cursor:pointer" data-bs-toggle="collapse" data-bs-target="#collapse-${item.key}">
                            <div>
                                <span class="fw-bold text-primary">ID: ${item.complaintId || item.key}</span>
                                <span class="priority-tag" style="color:${pColor}; border-color:${pColor}; background:${pColor}10">${p}</span>
                                ${isReopened ? '<span class="blink-badge ms-2">RE-OPENED</span>' : ''}
                            </div>
                            <span class="status-chip ${status === 'resolved' ? 's-resolved' : (status === 'in progress' ? 's-progress' : (isReopened ? 's-reopened' : 's-pending'))}">
                                ${status}
                            </span>
                        </div>
                        
                        <div id="collapse-${item.key}" class="collapse">
                            <div class="card-body border-top p-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="detail-row"><i class="bi bi-calendar-check"></i> <strong>Registered:</strong> ${formatTime(item.createdAt || item.timestamp)}</div>
                                        <div class="detail-row"><i class="bi bi-telephone"></i> <strong>Citizen:</strong> ${item.mobile || 'N/A'}</div>
                                    </div>
                                    <div class="col-md-6">
                                        ${item.work_started_at ? `<div class="detail-row"><i class="bi bi-play-circle"></i> <strong>Started:</strong> ${formatTime(item.work_started_at)}</div>` : ''}
                                        ${item.resolved_at && !isReopened ? `<div class="detail-row"><i class="bi bi-check-circle"></i> <strong>Resolved:</strong> ${formatTime(item.resolved_at)}</div>` : ''}
                                    </div>
                                </div>
                                
                                <div class="mt-3 p-3 rounded" style="background:#f1f5f9; border-left: 4px solid var(--teal)">
                                    <small class="text-uppercase fw-bold text-muted" style="font-size:10px">Description</small>
                                    <p class="mb-0 small">${item.description || 'No details provided.'}</p>
                                </div>

                                ${isReopened ? `
                                    <div class="mt-2 p-2 rounded" style="background:#fff5f5; border: 1px solid #feb2b2; color: #c53030">
                                        <small class="fw-bold">RE-OPEN REASON:</small>
                                        <p class="mb-0 small italic"><em>${currentRemarks || 'No feedback provided.'}</em></p>
                                    </div>
                                ` : ''}

                                <div class="mt-4">
                                    <label class="fw-bold small text-teal mb-1">OFFICER REMARKS / ACTION TAKEN</label>
                                    <textarea id="rem-${item.key}" class="form-control remarks-area" rows="3" ${status === 'resolved' ? 'disabled' : ''}>${defaultText}</textarea>
                                </div>

                                <div class="mt-3 d-flex justify-content-end gap-2">
                                    ${(status === 'pending' || isReopened) ? `
                                        <button class="btn-start" onclick="updateStatus('${item.key}', 'in progress')">
                                            <i class="bi bi-play-fill"></i> ${isReopened ? 'RESTART WORK' : 'START WORK'}
                                        </button>
                                    ` : ''}
                                    ${status !== 'resolved' ? `
                                        <button class="btn-resolve" onclick="updateStatus('${item.key}', 'resolved')">
                                            <i class="bi bi-check2-circle"></i> RESOLVE
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        });
    }

    function updateStatus(key, newStatus) {
        const remarks = document.getElementById(`rem-${key}`).value.trim();
        if (newStatus === 'resolved' && remarks === "") {
            alert("Please provide remarks before resolving.");
            return;
        }

        let updates = { status: newStatus, officer_remarks: remarks };
        if (newStatus === 'in progress') updates.work_started_at = firebase.database.ServerValue.TIMESTAMP;
        if (newStatus === 'resolved') updates.resolved_at = firebase.database.ServerValue.TIMESTAMP;

        db.ref('complaints/' + key).update(updates).then(() => {
            alert(`Status updated to ${newStatus}`);
        });
    }

    function logout() { auth.signOut().then(() => window.location.href='index.html'); }
    initFirebase();
</script>
</body>
</html>
